name: AI Test Impact Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  impact-test:
    name: Analyze and Run Impacted Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Analyze Impacted Tests
        id: analyze
        run: |
          echo "Analyzing impacted tests locally..."

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          RESPONSE=$(node scripts/analyze_impact.js "$BASE_SHA" "$HEAD_SHA")

          # Extract test files
          TESTS=$(echo $RESPONSE | jq -r '.impactedTests | join(" ")')
          COUNT=$(echo $RESPONSE | jq '.impactedTests | length')

          # Check if TESTS is empty or valid
          if [ -z "$TESTS" ] || [ "$TESTS" = "null" ]; then
             COUNT=0
             TESTS=""
          fi

          echo "impacted_tests=$TESTS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT tests to run: $TESTS"

      - name: Run Impacted Tests
        id: run_tests
        if: steps.analyze.outputs.count != '0'
        run: |
          # Execute only the impacted test files
          echo "Running command: npx jest ${{ steps.analyze.outputs.impacted_tests }}"
          npx jest ${{ steps.analyze.outputs.impacted_tests }} --json --outputFile=test-results.json || EXIT_CODE=$?

          TESTS_RUN=$(jq '.numTotalTests' test-results.json || echo 0)
          FAILED=$(jq '.numFailedTests' test-results.json || echo 0)

          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "${FAILED}" -ne "0" ] && [ "${FAILED}" != "null" ]; then
            exit 1
          fi

      - name: Report Results to Backend
        if: always() && steps.analyze.outputs.count != '0'
        env:
          BACKEND_URL: ${{ secrets.IMPACT_BACKEND_URL }}
        run: |
          curl -s -X POST "${BACKEND_URL}/api/report" \
            -H "Content-Type: application/json" \
            -d "{
              \"owner\": \"${{ github.repository_owner }}\",
              \"repo\": \"${{ github.event.repository.name }}\",
              \"pr\": ${{ github.event.pull_request.number }},
              \"testsRun\": ${{ steps.run_tests.outputs.tests_run || 0 }},
              \"testsFailed\": ${{ steps.run_tests.outputs.failed || 0 }}
            }"

          echo "Results reported to dashboard."
