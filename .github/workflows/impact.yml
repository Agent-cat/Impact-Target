name: AI Test Impact Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  impact-test:
    name: Analyze and Run Impacted Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Analyze Impacted Tests
        id: analyze
        env:o
          # This should be the URL of your dedicated Impact Analyzer Backend app
          BACKEND_URL: ${{ secrets.IMPACT_BACKEND_URL }}
        run: |
          echo "Requesting analysis for PR #${{ github.event.pull_request.number }}..."

          RESPONSE=$(curl -s -X POST "${BACKEND_URL}/api/analyze" \
            -H "Content-Type: application/json" \
            -d "{\"owner\": \"${{ github.repository_owner }}\", \"repo\": \"${{ github.event.repository.name }}\", \"pr\": ${{ github.event.pull_request.number }}}")

          # Extract test files
          TESTS=$(echo $RESPONSE | jq -r '.impactedTests | join(" ")')
          COUNT=$(echo $RESPONSE | jq '.impactedTests | length')

          echo "impacted_tests=$TESTS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT tests to run."

      - name: Run Impacted Tests
        id: run_tests
        if: steps.analyze.outputs.count != '0'
        run: |
          # Execute only the impacted test files
          npm test -- ${{ steps.analyze.outputs.impacted_tests }} --json --outputFile=test-results.json || EXIT_CODE=$?

          TESTS_RUN=$(jq '.numTotalTests' test-results.json || echo 0)
          FAILED=$(jq '.numFailedTests' test-results.json || echo 0)

          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ "${FAILED}" -ne "0" ] && [ "${FAILED}" != "null" ]; then
            exit 1
          fi

      - name: Report Results to Backend
        if: always() && steps.analyze.outputs.count != '0'
        env:
          BACKEND_URL: ${{ secrets.IMPACT_BACKEND_URL }}
        run: |
          curl -s -X POST "${BACKEND_URL}/api/report" \
            -H "Content-Type: application/json" \
            -d "{
              \"owner\": \"${{ github.repository_owner }}\",
              \"repo\": \"${{ github.event.repository.name }}\",
              \"pr\": ${{ github.event.pull_request.number }},
              \"testsRun\": ${{ steps.run_tests.outputs.tests_run || 0 }},
              \"testsFailed\": ${{ steps.run_tests.outputs.failed || 0 }}
            }"

          echo "Results reported to dashboard."
